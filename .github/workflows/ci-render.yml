name: CI/CD Pipeline (Render)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '18'

jobs:
  # ========================================
  # 1. Test & Security Check
  # ========================================
  test:
    name: Run Tests & Security Checks
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci --prefer-offline
        working-directory: ./server

      - name: Run linter (ESLint)
        run: npm run lint --if-present
        working-directory: ./server
        continue-on-error: true

      - name: Run unit tests
        run: npm test
        working-directory: ./server
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: test_user
          DB_PASSWORD: test_pass
          DB_NAME: test_db
          JWT_SECRET: test_secret_key_12345_abcdefghij
          GOOGLE_CLIENT_ID: test_google_client_id
          STRIPE_SECRET_KEY: sk_test_123456789
          NODE_ENV: test

      - name: Security audit
        run: npm audit --production
        working-directory: ./server
        continue-on-error: true

  # ========================================
  # 2. Code Quality Check
  # ========================================
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci --prefer-offline
        working-directory: ./server

      - name: Check code formatting (Prettier)
        run: npm run format:check --if-present
        working-directory: ./server
        continue-on-error: true

  # ========================================
  # 3. Deploy to Render (Production only)
  # ========================================
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: [test, code-quality]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to Render
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"ref": "main"}'
